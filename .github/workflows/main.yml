name: Notification Pipeline
on:
  schedule:
    - cron: "0 * * * *"
  push:
    branches: ["main", "dev"]
env:
  TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  get_data:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Print env variable
        run: |
          echo "SSO_NRP: ${{ vars.SSO_NRP }}"
          echo "SSO_NRP: ${{ secrets.SSO_NRP }}"
          echo "SSO_NRP: ${{ env.SSO_NRP }}"
          echo "TELEGRAM_CHAT_ID: ${{ vars.TELEGRAM_CHAT_ID }}"
      - uses: cypress-io/github-action@v6
        name: Scrapping data from SIAKAD
        env:
          SSO_NRP: ${{ vars.SSO_NRP }}
          SSO_PASSWORD: ${{ vars.SSO_PASSWORD }}
      - name: Upload data file as artifact
        uses: actions/upload-artifact@v3
        with:
          name: my-data
          path: dist/

  send_notification:
    needs: get_data
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18
      - name: Download static json artifact
        uses: actions/download-artifact@v3
        with:
          name: my-data
          path: dist/
      - name: Send notification via telegram
        run: |
          npm install
          npm run start
